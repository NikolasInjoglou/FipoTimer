<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <title>Weekly Time Tracker</title>
    <style>
        body { font-family: sans-serif; padding: 30px; background: #f9fafb; }
        .bar { width: 100%; height: 30px; background: #ddd; margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
        .gameFill { height: 30px; background: #b925e4; width: 0; transition: width 0.4s; }
        .cartoonFill { height: 30px; background: #71b9fd; width: 0; transition: width 0.4s; }
        .fill { height: 30px; background: #a51221; width: 0; transition: width 0.4s; }
        h2 { margin-top: 40px; }
        button { margin-right: 10px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.start { background-color: #03b303; color: white; }
        button.stop { background-color: #f44336; color: white; }
        button.add { background-color: #71b9fd; color: white; }
        input { padding: 5px; width: 80px; margin-right: 8px; }
        .section { margin-bottom: 60px; }
        .finished { color: red; font-size: 1.5em; font-weight: bold; margin-top: 10px; }
        .timer-text { margin-top: 5px; }
    </style>
</head>
<body>
<h1>ğŸ“… Î•Î²Î´Î¿Î¼Î±Î´Î¹Î±Î¯Î¿Ï‚ Î§ÏÏŒÎ½Î¿Ï‚ Cartoon ÎºÎ±Î¹ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</h1>

<div class="section" id="gameSection">
    <h2>ğŸ® Î§ÏÎ¿Î½ÏŒÎ¼ÎµÏ„ÏÎ¿ Î Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï</h2>
    <div class="bar"><div id="gameFill" class="gameFill"></div></div>
    <button class="start" onclick="start('game')">â–¶ï¸  ğŸ®  Î‘ÏÏ‡Î®</button>
    <button class="stop" onclick="stopTimer('game')">â¹ï¸  ğŸ®  Î£Ï„Î¿Ï€</button>
    <input id="gameInput" type="number" placeholder="Î›ÎµÏ€Ï„Î¬">
    <button class="add" onclick="addTime('game')">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
    <p id="gameText" class="timer-text"></p>
    <p id="gameEndMsg" class="finished"></p>
    <p id="gameStartInfo" class="timer-text"></p>
    <p id="gameStopInfo" class="timer-text"></p>
    <p id="gameDurationInfo" class="timer-text"></p>
</div>

<div class="section" id="cartoonSection">
    <h2>ğŸ“º Î§ÏÎ¿Î½ÏŒÎ¼ÎµÏ„ÏÎ¿ Cartoon</h2>
    <div class="bar"><div id="cartoonFill" class="cartoonFill"></div></div>
    <button class="start" onclick="start('cartoon')">â–¶ï¸  ğŸ“º  Î‘ÏÏ‡Î®</button>
    <button class="stop" onclick="stopTimer('cartoon')">â¹ï¸  ğŸ“º  Î£Ï„Î¿Ï€</button>
    <input id="cartoonInput" type="number" placeholder="Î›ÎµÏ€Ï„Î¬">
    <button class="add" onclick="addTime('cartoon')">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
    <p id="cartoonText" class="timer-text"></p>
    <p id="cartoonEndMsg" class="finished"></p>
    <p id="cartoonStartInfo" class="timer-text"></p>
    <p id="cartoonStopInfo" class="timer-text"></p>
    <p id="cartoonDurationInfo" class="timer-text"></p>
</div>

<div>
    <h3>ğŸ“œ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î±Î¹Ï‡Î½Î¹Î´Î¹ÏÎ½</h3>
    <div id="gameSessions"></div>
</div>

<div>
    <h3>ğŸ“œ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Cartoon</h3>
    <div id="cartoonSessions"></div>
</div>

<script>
    let timers = { game: null, cartoon: null };
    let status = {};
    let config = {};

    // ---- Helpers ----
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    async function loadConfig() {
        const res = await fetch('/api/time/config');
        config = await res.json();
    }

    async function loadStatus() {
        const res = await fetch("/api/time/status");
        status = await res.json();
        updateBars();
        renderSessions();
    }

    function renderSessions() {
        const fmt = new Intl.DateTimeFormat('el-GR', {
            weekday: 'short', day: '2-digit', month: 'short',
            hour: '2-digit', minute: '2-digit', hour12: false
        });
        const fmtDur = (s) => s > 0 ? formatTime(s) : '';

        const gameList = status.gameSessions?.map(
            s => `<li>${fmt.format(new Date(s.start))} â†’ ${fmt.format(new Date(s.stop))} | ${fmtDur(s.durationSec)}</li>`
        ).join('') || '';

        const cartoonList = status.cartoonSessions?.map(
            s => `<li>${fmt.format(new Date(s.start))} â†’ ${fmt.format(new Date(s.stop))} | ${fmtDur(s.durationSec)}</li>`
        ).join('') || '';

        document.getElementById('gameSessions').innerHTML = `<ul>${gameList}</ul>`;
        document.getElementById('cartoonSessions').innerHTML = `<ul>${cartoonList}</ul>`;
    }

    function updateBars() {
        const gamePct = (status.usedGame / config.totalGame) * 100;
        const cartoonPct = (status.usedCartoon / config.totalCartoon) * 100;
        document.getElementById('gameFill').style.width = gamePct + '%';
        document.getElementById('cartoonFill').style.width = cartoonPct + '%';

        const gameRemain = Math.max(config.totalGame - status.usedGame, 0);
        const cartoonRemain = Math.max(config.totalCartoon - status.usedCartoon, 0);

        const fmt = new Intl.DateTimeFormat('el-GR', {
            weekday: 'long', day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: false
        });

        const fmtTime = (t) => t ? fmt.format(new Date(t)) : '';
        const fmtDur = (s) => s > 0 ? formatTime(s) : '';

        document.getElementById('gameText').innerText =
            `Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï‚: ${formatTime(status.usedGame)} / ${formatTime(config.totalGame)} (${gamePct.toFixed(1)}%)\n` +
            `Î¥Ï€Î¿Î»ÎµÎ¹Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚: ${formatTime(gameRemain)}`;

        document.getElementById('cartoonText').innerText =
            `Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¼Î­Î½Î¿Ï‚: ${formatTime(status.usedCartoon)} / ${formatTime(config.totalCartoon)} (${cartoonPct.toFixed(1)}%)\n` +
            `Î¥Ï€Î¿Î»ÎµÎ¹Ï€ÏŒÎ¼ÎµÎ½Î¿Ï‚: ${formatTime(cartoonRemain)}`;

        // Start / Stop / Duration
        document.getElementById('gameStartInfo').innerText =
            status.gameStartTime ? `ÎÎµÎºÎ¯Î½Î·ÏƒÎµ: ${fmtTime(status.gameStartTime)}` : '';
        document.getElementById('gameStopInfo').innerText =
            status.gameStopTime ? `Î£Ï„Î±Î¼Î¬Ï„Î·ÏƒÎµ: ${fmtTime(status.gameStopTime)}` : '';
        document.getElementById('gameDurationInfo').innerText =
            status.lastGameDurationSec > 0 ? `Î”Î¹Î®ÏÎºÎ·ÏƒÎµ: ${fmtDur(status.lastGameDurationSec)}` : '';

        document.getElementById('cartoonStartInfo').innerText =
            status.cartoonStartTime ? `ÎÎµÎºÎ¯Î½Î·ÏƒÎµ: ${fmtTime(status.cartoonStartTime)}` : '';
        document.getElementById('cartoonStopInfo').innerText =
            status.cartoonStopTime ? `Î£Ï„Î±Î¼Î¬Ï„Î·ÏƒÎµ: ${fmtTime(status.cartoonStopTime)}` : '';
        document.getElementById('cartoonDurationInfo').innerText =
            status.lastCartoonDurationSec > 0 ? `Î”Î¹Î®ÏÎºÎ·ÏƒÎµ: ${fmtDur(status.lastCartoonDurationSec)}` : '';

        // End messages
        document.getElementById('gameEndMsg').innerText =
            status.usedGame >= config.totalGame ? 'â›” Î¤ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ ğŸ® Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±!' : '';
        document.getElementById('cartoonEndMsg').innerText =
            status.usedCartoon >= config.totalCartoon ? 'â›” Î¤ÎµÎ»ÎµÎ¯Ï‰ÏƒÎµ Î¿ Ï‡ÏÏŒÎ½Î¿Ï‚ ğŸ“º Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±!' : '';
    }

    async function start(type) {
        await fetch(`/api/time/start?type=${type}`, { method: 'POST' });
        await loadStatus();
    }

    async function stopTimer(type) {
        await fetch(`/api/time/stop?type=${type}`, { method: 'POST' });
        await loadStatus();
    }

    setInterval(loadStatus, 2000);

    async function addTime(type) {
        const val = document.getElementById(type + 'Input').value;
        if (!val) return;
        const seconds = parseInt(val) * 60; // convert minutes â†’ seconds
        await fetch(`/api/time/update?type=${type}&seconds=${seconds}`, { method: 'POST' });
        await loadStatus();
    }

    function restoreState() {
        const saved = JSON.parse(localStorage.getItem('runningTimers') || '[]');
        saved.forEach(type => start(type));
    }

    async function init() {
        await loadConfig();
        await loadStatus();
        restoreState();
    }

    init();

</script>
</body>
</html>